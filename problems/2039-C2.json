{
    "statement": "This is the hard version of the problem. The differences between the two versions are highlighted in bold. You can only make hacks if both versions of the problem are solved.Shohag has two integers x and m. Help him count the number of integers 1 ≤ y ≤ m such that x \\oplus y is divisible^{\\text{∗}} by either x, y, or both. Here \\oplus is the bitwise XOR operator.^{\\text{∗}}The number a is divisible by the number b if there exists an integer c such that a = b · c.",
    "input_specification": "InputThe first line contains a single integer t (1 ≤ t ≤ 10^4) — the number of test cases.The first and only line of each test case contains two space-separated integers x and m (1 ≤ x ≤ 10^6, 1 ≤ m ≤ 10^{18}).It is guaranteed that the sum of x over all test cases does not exceed 10^7.",
    "output_specification": "OutputFor each test case, print a single integer — the number of suitable y.",
    "sample_tests": [
        {
            "input": "5\n7 10\n2 3\n6 4\n1 6\n4 1",
            "output": "3\n2\n2\n6\n1"
        }
    ],
    "note": "In the first test case, for\nx=7\n, there are\n3\nvalid values for\ny\namong the integers from\n1\nto\nm=10\n, and they are\n1\n,\n7\n, and\n9\n.",
    "tags": [
        "bitmasks",
        "brute force",
        "math",
        "number theory"
    ],
    "rating": "1800"
}